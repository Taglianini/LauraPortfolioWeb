---
// src/components/Galeria.astro
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

// 1. MODIFICACIÓN AQUÍ: Agregamos 'titulo' a la lista de cosas permitidas
interface Props {
  titulo: string; // <--- AGREGADO: El título de la categoría
  images: {
    src: ImageMetadata;
    alt: string;
    titulo?: string;
  }[];
}

// 2. MODIFICACIÓN AQUÍ: Lo extraemos para usarlo abajo
const { images, titulo } = Astro.props; 
---

<h1 class="text-3xl sm:text-6xl md:text-6xl font-light uppercase tracking-[0.2em] md:tracking-[0.6em] mb-12 -mt-20 text-center pl-[0.2em] md:pl-[0.6em]">
    {titulo}
</h1>

<div id="mi-galeria" class="relative w-full mx-auto transition-all duration-500 opacity-0" class:list={["opacity-100"]}>
  
  {images.map((imagen) => (
    <div class="masonry-item absolute top-0 left-0 w-full sm:w-1/2 lg:w-1/3 p-2 hover:z-50 transition-all duration-500 ease-in-out">
      
      <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-500 ease-in-out hover:scale-105">
        <Image 
          src={imagen.src} 
          alt={imagen.alt} 
          width={600}
          class="block w-full h-auto object-cover"
        />
        
        {imagen.titulo && (
          <div class="p-4">
            <h3 class="font-serif text-primary text-lg font-bold uppercase tracking-wider text-center">
                {imagen.titulo}
            </h3>
          </div>
        )}
      </div>

    </div>
  ))}

</div>

<script>
  import MiniMasonry from "minimasonry";

  function initMasonry() {
    const container = document.getElementById('mi-galeria');
    
    if (container) {
      // 1. Inicializamos MiniMasonry
      const masonry = new MiniMasonry({
        container: container,
        gutter: 0,
        baseWidth: 280,
        surroundingGutter: false
      });

      // Función auxiliar para recalcular
      const recalcular = () => {
          masonry.layout();
          container.classList.remove('opacity-0');
      };

      // 2. Ejecutar inmediatamente (por si ya hay caché)
      recalcular();

      // 3. Vigilar cada imagen individualmente
      const imgs = container.querySelectorAll('img');
      imgs.forEach(img => {
          if (img.complete) {
              recalcular();
          } else {
              // Cada vez que una foto termine de cargar, reordenamos todo
              img.addEventListener('load', recalcular);
          }
      });

      // 4. EL FIX MÁGICO PARA LOCALHOST (Failsafe)
      // Forzamos un recálculo a los 500ms y a los 2 segundos.
      // Esto arregla los casos donde el navegador tarda en pintar la altura.
      setTimeout(recalcular, 250);
      setTimeout(recalcular, 500);
      setTimeout(recalcular, 2000);
    }
  }

  // Ejecutamos en carga inicial y navegaciones de Astro
  document.addEventListener('astro:page-load', initMasonry);
  
  // Recalcular si cambian el tamaño de la ventana
  window.addEventListener('resize', () => {
      const container = document.getElementById('mi-galeria');
      if(container) {
         // Truco: a veces hay que reiniciar la instancia en resize
         // pero generalmente layout() alcanza.
         // new MiniMasonry({ container... }).layout(); 
         // Si MiniMasonry expone la instancia globalmente sería mejor, 
         // pero re-ejecutar initMasonry es seguro aquí.
         initMasonry(); 
      }
  });
</script>