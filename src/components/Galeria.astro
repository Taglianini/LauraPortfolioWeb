---
// src/components/Galeria.astro
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro'; // Importamos el tipo de imagen de Astro

// Definimos la estructura exacta que deben tener tus datos
interface Props {
  images: {
    src: ImageMetadata; // El archivo de imagen importado
    alt: string;        // El texto alternativo
    titulo?: string;    // El título (el '?' significa que es opcional)
  }[];
}

// Ahora Astro ya sabe que 'images' cumple con la estructura de arriba
const { images } = Astro.props;
---

<div id="mi-galeria" class="relative w-full mx-auto transition-all duration-500 opacity-0" class:list={["opacity-100"]}>
  
  {images.map((imagen) => (
    /* IMPORTANTE: MiniMasonry necesita que los hijos sean 'absolute'.
       Usamos clases de Tailwind para definir el ancho de columna:
       - w-full (1 columna en móvil)
       - sm:w-1/2 (2 columnas)
       - lg:w-1/3 (3 columnas)
    */
    <div class="masonry-item absolute top-0 left-0 w-full sm:w-1/2 lg:w-1/3 p-2">
      
      <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300">
        <Image 
          src={imagen.src} 
          alt={imagen.alt} 
          width={600}
          class="block w-full h-auto object-cover"
        />
        
        {/* Renderizado condicional: Solo muestra el título si existe */}
        {imagen.titulo && (
          <div class="p-4">
            <h3 class="font-serif text-primary text-lg font-bold uppercase tracking-wider text-center">
                {imagen.titulo}
            </h3>
          </div>
        )}
      </div>

    </div>
  ))}

</div>

<script>
  import MiniMasonry from "minimasonry";

  // Función para iniciar la galería
  function initMasonry() {
    const container = document.getElementById('mi-galeria');
    
    if (container) {
      // 1. Inicializamos MiniMasonry
      const masonry = new MiniMasonry({
        container: container,
        gutter: 0, // El espaciado lo maneja el padding de Tailwind (p-2)
        baseWidth: 280, // Punto de quiebre aproximado
        surroundingGutter: false
      });

      // 2. Truco para que aparezca suavemente (Fade In)
      // A veces masonry tarda milisegundos en calcular, esto evita que se vea "roto" al principio
      container.classList.remove('opacity-0');
      
      // 3. Forzar recalculo después de que las imágenes carguen (por seguridad)
      // Esto arregla bugs visuales si las imágenes tardan en bajar
      const imgs = container.querySelectorAll('img');
      imgs.forEach(img => {
          if (img.complete) {
              masonry.layout();
          } else {
              img.addEventListener('load', () => masonry.layout());
          }
      });
    }
  }

  // CRÍTICO: Usamos 'astro:page-load' para compatibilidad con ClientRouter
  document.addEventListener('astro:page-load', initMasonry);
  
  // Recalcular en resize de ventana
  window.addEventListener('resize', initMasonry);
</script>